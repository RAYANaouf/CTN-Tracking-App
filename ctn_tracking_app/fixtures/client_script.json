[
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Stock Entry",
  "enabled": 1,
  "modified": "2025-12-13 03:08:42.491023",
  "module": "CTN Tracking App",
  "name": "Auto Fulfilling",
  "script": "frappe.ui.form.on('Stock Entry', {\r\n\r\n\tcustom_transfer_by_ctns(frm) {\r\n\t\tupdate_items_from_ctns(frm);\r\n\t}\r\n});\r\n\r\n\r\nfrappe.ui.form.on('Stock Entry Carton', {\r\n\tcustom_carton_table_remove(frm) {\r\n\t\tupdate_items_from_ctns(frm);\r\n\t},\r\n\r\n\tcarton(frm) {\r\n\t\tupdate_items_from_ctns(frm);\r\n\t}\r\n});\r\n\r\nfunction update_items_from_ctns(frm) {\r\n    \r\n    const is_receipt = frm.doc.stock_entry_type === \"Material Receipt\";\r\n    \r\n\tif (!frm.doc.custom_transfer_by_carton || !frm.doc.custom_carton_table.length) return;\r\n\r\n\tfrm.clear_table(\"items\");\r\n\tfrm.refresh_field(\"items\");\r\n\r\n    const ctn_names = frm.doc.custom_carton_table.map(row => row.carton)\r\n\r\n\r\n    console.log(\"the =>>>> \" , ctn_names)\r\n    \r\n    frappe.call({\r\n        method : \"ctn_tracking_app.api.get_items_from_ctns\",\r\n        args : { ctn_list : ctn_names},\r\n        freeze : true,\r\n        freeze_message : \"Fetching items from CTNs ...\",\r\n        callback : function(r){\r\n            if(!r.message) return;\r\n            frm.clear_table(\"items\");\r\n            r.message.forEach(item => {\r\n                frm.add_child(\"items\" , {\r\n                    item_code         : item.item_code,\r\n                    qty               : item.qty ,\r\n                    uom               : item.uom || \"\",\r\n                    stock_uom         : item.uom || \"\",\r\n                    transfer_qty      : item.qty * item.conversion_factor,\r\n                    conversion_factor : item.conversion_factor || 1 ,\r\n                    s_warehouse       : is_receipt ? \"\" :item.s_warehouse,\r\n                    t_warehouse       : frm.doc.to_warehouse //default to warhouse on issue just dont set it.\r\n                })\r\n            })\r\n            \r\n            frm.refresh_field(\"items\");\r\n            frappe.show_alert(\"Items updated from CTNs\")\r\n        }\r\n    })\r\n\r\n}\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Carton",
  "enabled": 1,
  "modified": "2025-12-13 03:51:43.607996",
  "module": "CTN Tracking App",
  "name": "carton client script",
  "script": "\nfrappe.ui.form.on(\"Carton\", {\n  refresh(frm) {\n    \n    // If the document is already saved (not new):\n    if (!frm.is_new()) {\n      frm.set_df_property(\"ref\"       , \"read_only\", 1);\n      frm.set_df_property(\"ctn_num\"   , \"read_only\", 1);\n      frm.set_df_property(\"items\"     , \"read_only\", 1);\n      frm.set_df_property(\"company\"   , \"read_only\", 1);\n      frm.set_df_property(\"warehouse\" , \"read_only\", 1);\n    } else {\n      frm.set_df_property(\"ref\", \"read_only\", 0);\n    }\n\n    // Fetch transactions if saved\n    if (!frm.is_new()) {\n        frappe.call({\n            method: \"ctn_tracking_app.ctn_tracking_app.doctype.carton.carton.get_transactions\",\n            args: {\n                carton_name: frm.doc.name\n            },\n            callback: function(r) {\n                if (r.message) {\n                    let data = r.message;\n                    console.log(\"data ==> \", data)\n            \n                    // Build a Bootstrap-styled table with border-radius, no top margin\n                    let html = `\n                        <div class=\"table-responsive\"\n                            style=\"border: 1px solid #dee2e6; \n                            border-radius: 6px; \n                            overflow: hidden; \n                            margin: 0; \n                            padding: 0;\">\n                        <table class=\"table table-hover table-striped mb-0\" style=\"margin: 0;\">\n                            <thead>\n                                <tr>\n                                    <th>Type</th>\n                                    <th>Reference</th>\n                                    <th>Item</th>\n                                    <th>Qty</th>\n                                </tr>\n                            </thead>\n                        <tbody>\n                    `;\n\n                    data.forEach(row => {\n                        console.log(\"row ==--==> \" , row)\n                        html += `\n                            <tr>\n                                <td>${row.type || \"\"}</td>\n                                <td>${row.ref || \"\"}</td>\n                                <td>${row.item || \"\"}</td>\n                                <td>${row.qty}</td>\n                            </tr>\n                        `;\n                    });\n\n                    html += `\n                        </tbody>\n                        </table>\n                        </div>\n                    `;\n\n\n                    // Inject into the HTML field\n                    frm.fields_dict[\"transactions_html\"].$wrapper.html(html);\n            \n            \n                    // 2) Now compute the \"current state\" of each Item.\n                    //    doc.items holds the initial quantities,\n                    //    and that each transaction row is an \"outbound\" (subtract) quantity.\n            \n                    let itemMap = {};\n            \n                    // A) Start with the \"init items\" in the CTN\n            \n                    if (frm.doc.items) {\n                        frm.doc.items.forEach(initRow => {\n                            console.log(\"initRow ==> \" , initRow)\n                            if (initRow.item) {\n                                itemMap[initRow.item] = (itemMap[initRow.item] || 0) + (initRow.qty || 0);\n                            }\n                        });\n                    }\n                    \n                    \n                            console.log(\"itemMap ==> \" , itemMap)\n            \n                    // B) Add the transaction quantities\n                    data.forEach(txn => {\n                        if (txn.item) {\n                            if(txn.type == \"In\"){\n                                itemMap[txn.item] = (itemMap[txn.item] || 0) + (txn.qty || 0);\n                            }else {\n                                itemMap[txn.item] = (itemMap[txn.item] || 0) - (txn.qty || 0);    \n                            }\n                            \n                        }\n                    });\n            \n            \n                    // 3) Build a second table for the \"CTN Status\" HTML field\n                    let statusHtml = `\n                        <div class=\"table-responsive\"\n                            style=\"border: 1px solid #dee2e6;\n                            border-radius: 6px;\n                            overflow: hidden;\n                            margin-top: 1rem;\">\n                            <table class=\"table table-hover table-striped mb-0\" style=\"margin: 0;\">\n                                <thead>\n                                    <tr>\n                                        <th>Item</th>\n                                        <th>Remaining Qty</th>\n                                    </tr>\n                                </thead>\n                            <tbody>\n                    `;\n            \n            \n                    Object.keys(itemMap).forEach(itemCode => {\n                        statusHtml += `\n                            <tr>\n                                <td>${itemCode}</td>\n                                <td>${itemMap[itemCode]}</td>\n                            </tr>\n                        `;\n                    });\n            \n            \n                    statusHtml += `\n                        </tbody>\n                        </table>\n                        </div>\n                    `;\n\n                    // 4) Inject the status table into your \"ctn_status_html\" field\n                    frm.fields_dict[\"ctn_status_html\"].$wrapper.html(statusHtml);\n            \n                }else{\n              \n                    // If no transactions found, clear the fields (or show a message)\n                    frm.fields_dict[\"transactions_html\"].$wrapper.html(\"\");\n                    frm.fields_dict[\"ctn_status_html\"].$wrapper.html(\"No Transactions Found.\");\n                }\n            }\n        });\n    } else {\n      // If it's a new doc, clear both HTML fields\n      frm.fields_dict[\"transactions_html\"].$wrapper.html(\"\");\n      frm.fields_dict[\"ctn_status_html\"].$wrapper.html(\"\");\n    }\n  },\n  \n  company(frm){\n      frm.set_query(\"warehouse\", function() {\n            return { filters: { company: frm.doc.company } };\n        });\n  }\n});\n",
  "view": "Form"
 }
]